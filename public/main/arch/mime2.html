<!DOCTYPE html>
<html lang="RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="/assets/styles/style.css">
    <link rel="stylesheet" href="/assets/highlight/styles_custom/androidstudio.css">
</head>
<body>
<script src="/assets/highlight/highlight.min.js"></script>
<p><a href="/arch">Вернуться назад</a></p>

<h1>MIME2</h1>

<p>Я хочу создать текстовый файл с расширением ".bulka". Мне это нужно для того, чтобы при клике по этому текстовому файлу, он открывался с помощью определённой программы. Чтобы обычный текстовый файл открывался с помощью одной программы, например, <strong><i>Leafpad</i></strong>, а текстовый файл с расширением ".bulka" - с помощью <strong><i>VSCodium</i></strong>.</p>

<p>Создадим XML-файл "~/.local/share/mime/packages/application-x-bulochka.xml":</p>
<pre><code class="language-xml">
&lt;mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info"&gt;
    &lt;mime-type type="application/x-bulka"&gt;
        &lt;glob pattern="*.bulka"/&gt;
    &lt;/mime-type&gt;
&lt;/mime-info&gt;
</code></pre>

<p>Обновим базу данных MIME:</p>
<pre><code class="language-bash">
   update-mime-database ~/.local/share/mime
</code></pre>

<p>Проверим, видит ли система наш новый тип:</p>
<pre><code class="language-bash">
    grep -R "application/x-bulka" ~/.local/share/mime/
</code></pre>

<p>Вот вывод, который я получил:</p>
<pre><code class="language-bash">
   /home/mark/.local/share/mime/globs:application/x-bulka:*.bulka
   /home/mark/.local/share/mime/types:application/x-bulka
   /home/mark/.local/share/mime/application/x-bulka.xml:<mime-type xmlns="http://www.freedesktop.org/standards/shared-mime-info" type="application/x-bulka">
   grep: /home/mark/.local/share/mime/mime.cache: двоичный файл совпадает
   /home/mark/.local/share/mime/packages/application-x-bulochka.xml:    <mime-type type="application/x-bulka">
   /home/mark/.local/share/mime/globs2:50:application/x-bulka:*.bulka
</code></pre>


<p>Теперь я хочу создать свой файл с расширением ".bulka":</p>
<pre><code class="language-bash">
   echo "Первая строка, которую мы вставляем в файл." >> myfile.bulka
   echo "Вторая строка" >> myfile.bulka
</pre></code>

<p>Этот файл (myfile.bulka) по факту является типом "text/plain". Но мы определили в файле <strong><i>application-x-bulochka.xml</i></strong>, что все файлы с расширением ".bulka" должны определяться как наш новый тип "application/x-bulka". Давайте попробуем определить тип файла разными способами:</p>
<pre><code class="language-bash">
   # с помощью утилиты file:
   file --mime-type myfile.bulka
      #  myfile.bulka: text/plain

   # с помощью xdg-mime
   xdg-mime query filetype myfile.bulka
      #  text/plain

   # с помощью gio:
   gio info myfile.bulka | grep content-type
      #  standard::content-type: application/x-bulka
      #  standard::fast-content-type: application/x-bulka
</code></pre>

<p>Как видим, разные утилиты определяют тип по-разному. Утилита <strong><i>file</i></strong> говорит, что наш файл имеет тип "text/plain". А вот <strong><i>gio</i></strong> говорит, что тип нашего файла: "application/x-bulka". А вот скрипт <strong><i>xdg-mime</i></strong> под капотом использует утилиту <strong><i>file</i></strong>, поэтому результат такой же, как когда мы спрашиваем тип у <strong><i>file</i></strong>.</p>
<p>Всё дело в том, что <strong><i>gio</i></strong>, когда пытается определить тип файла, опирается на нашу локальную базу данных MIME-типов, в которую мы добавили тип "application/x-bulka". А вот file залезает в файл и читает его содержимое и на основе содержимого определяет тип файла.</p>
<p>Файловые менеджеры, такие как <strong><i>PCManFM</i></strong> или <strong><i>Thunar</i></strong>, определяют тип файла на основе нашей MIME-базы данных. Поэтому когда мы кликаем по файлу, чтобы он открылся, система по расширению .bulka понимает, что это наш тип "application/x-bulka". Но если мы хотим, чтобы наш файл открывался с помощью нужной нам программы, то нам надо ещё привязать наш MIME-тип к конкретной программе.</p>

<pre><code class="language-bash">
   # Проверим, какое приложение является дефолтным для нашего типа:
   xdg-mime query default application/x-bulka

      # скорее всего эта команда ничего не вернёт, потому что мы пока не указывали ...
      # ... дефолтное приложение для нашего MIME-типа.
</code></pre>

<p>Теперь я хочу сделать так, чтобы при клике по файлу с расширением .bulka, он открывался с помощью программы <strong><i>VSCodium</i></strong>:</p>
<pre><code class="language-bash">
   # Привязываю VSCodium к типу application/x-bulka:
   xdg-mime default codium-wayland.desktop application/x-bulka

   # Ещё раз проверяю, какое приложение привязано к нашему типу:
   xdg-mime query default application/x-bulka
      # codium-wayland.desktop

   # Проверю также, какое приложение у меня привязано к обычному текстовому файлу:
   xdg-mime query default text/plain
      # leafpad.desktop
</code></pre>


<p>Теперь я могу в файловом менеджере кликать по текстовому файлу <strong><i>myfile.bulka</i></strong> и он будет открываться с помощью программы <strong><i>VSCodium</i></strong>. При этом обычный текстовый файл <strong><i>myfile.txt</i></strong> откроется с помощью <strong><i>Leafpad</i></strong>.</p>
<p>НО! Важно, что все программы опредляют тип по-своему. Если большинство файловых менеджеров опираются на базу данных MIME-типов в нашей системе, то некоторые программы используют утилиту <strong><i>file</i></strong> для определения типа файла. Например, если мы попробуем открыть файл с помощью <strong><i>xdg-open</i></strong>, то этот скрипт определит тип файла с помощью утилиты <strong><i>file</i></strong> и решит, что у нас обычный текстовый файл "text/plain" и соответственно откроет файл с помощью программы <strong><i>Leafpad</i></strong>.</p>
<pre><code class="language-bash">
   xdg-open myfile.bulka

      #  должен открыться с помощью Leafpad
</code></pre>

<p>Файловый менеджер <strong><i>lf</i></strong> также использует <strong><i>file</i></strong>, поэтому откроет наш файл через <strong><i>Leafpad</i></strong>.</p>

<p>Когда я привязываю программу к MIME-типу с помощью <strong><i>xdg-mime</i></strong>, привязка записывается в файл <strong><i>mimeapps.list</i></strong>.</p>

<pre><code class="language-bash"># ~/.config/mimeapps.list:
# ~/.local/share/applications/mimeapps.list:
   # /usr/share/applications/mimeapps.list:
   # /usr/local/share/applications/mimeapps.list:

   [Default Applications]
   application/x-bulka=leafpad.desktop
</code></pre>
<p>Ещё несколько файлов, раскиданных по системе:</p>
<pre><code>   # /etc/mime.types

   # /usr/share/mime/mime.cache
   # ~/.local/share/mime/mime.cache

   # /usr/share/applications/mimeinfo.cache
   # ~/.local/share/applications/mimeinfo.cache

   # ~/.local/share/applications/mimeapps.list
   # ~/.config/mimeapps.list
</code></pre>
<p>Если я не привязал тип <strong><i>text/x-bulka</i></strong> к какой-либо программе и кликаю по файлу <strong><i>myfile.bulka</i></strong>, то <strong><i>PCManFM</i></strong> предложит мне самому выбрать программу, которой я хочу открывать этот файл. Я выбираю <strong><i>VSCodium</i></strong> и файл открывается с помощью <strong><i>VSCodium</i></strong>. После этого привязка <strong><i>text/x-bulka</i></strong> и <strong><i>codium.desktop</i></strong> сохранится в файл <strong><i>~/.config/mimeapps.list</i></strong> и при последующих кликах по файлу он всегда будет открываться с помощью <strong><i>VSCodium</i></strong>. Теперь все программы, которые используют <strong><i>shared-mime-info</i></strong>, будут открывать файлы с расширеним <strong><i>.bulka</i></strong> с помощью <strong><i>VSCodium</i></strong>.</p>

<h2>Утилита <i>update-desktop-database</i></h2>

<p>Файлы <strong><i>mimeinfo.cache</i></strong> создаются и обновляются утилитой <strong><i>update-desktop-database</i></strong>.</p>
<p>Утилита <strong><i>update-desktop-database</i></strong> сканирует все .desktop-файлы в каталогах <strong></i>~/.local/share/applications/</i></strong> и <strong><i>/usr/share/applications/</i></strong> и собирает из них информацию о том, какие программы заявляют поддержку каких MIME-типов. И она записывает эту информацию в файл <strong><i>mimeinfo.cache</i></strong> в том же каталоге.</p>
<p>То есть, <strong><i>mimeinfo.cache</i></strong> - это ускоритель. Программа каждый раз не лазит по всем .desktop-файлам, она заглядывает в <strong><i>mimeinfo.cache</i></strong>.</p>
<p>Допустим, у меня есть файл leafpad.desktop, в котором написано:</p>
<pre><code class="language-bash"># /usr/share/applications/leafpad.desktop

  [Desktop Entry]
  Name=Leafpad
  Exec=leafpad %f
  MimeType=text/plain;text/x-bulka;
</code></pre>

<p>Я запускаю команду:</p>
<pre><code class="language-bash">  update-desktop-database ~/.local/share/applications
</code></pre>

<p><ul>
      <li>Утилита <strong><i>update-desktop-database</i></strong> найдёт все .desktop-файлы в этом каталоге,</li>
      <li>вытащит оттуда все строки "MimeType=...",</li>
      <li>соберёт их в кэш <strong><i>~/.local/share/applications/mimeinfo.cache</i></strong>, например:</li>
</ul></p>
<pre><code class="language-bash"># ~/.local/share/applications/mimeinfo.cache

  [MIME Cache]
  text/plain=leafpad.desktop;
  text/x-bulka=leafpad.desktop;
</code></pre>
<p>Обычно <strong><i>update-desktop-database</i></strong> не вызывают вручную. Обычно её вызывает пакетный менеджер автоматически после установки новой программы. Только если я вручную добавил новый .desktop-файл или изменил "<strong><i>MimeType=</i></strong>" в существующем, имеет смысл вызвать <strong><i>update-desktop-database</i></strong>. Или при добавлении нового MIME-типа.</p>
<p>То есть, чтобы программа официально стала поддерживать мой тип, я должен вручную открыть её .desktop-файл, добавить туда свой тип и запустить команду: update-desktop-database ~/.local/share/applications, чтобы обновить <strong><i>mimeinfo.cache</i></strong>.</p>

<ul><h3>Приблизительная последовательность действий при создании нового MIME-типа:</h3>
   <li>Создаём XML-файл</li>
   <li>Запускаем команду: update-mime-database ~/.local/share/mime</li>
   <li>Открываем файл codium-wayland.desktop и добавляем туда после "MimeTypes=" наш <strong><i>text/x-bulka</i></strong>:
      <pre><code class="language-bash">MimeType=text/plain;inode/directory;text/x-bulka;</code></pre>
   </li>
   <li>Запускаем команду: update-desktop-database ~/.local/share/applications</li>
   <li>Привязываем к MIME-типу программу: xdg-mime default codium-wayland.desktop text/x-bulka</li>
</ul>


<h2>Утилита <i>file</i></h2>

<p>Может, можно как-то сделать, чтобы утилита <strong><i>file</i></strong> тоже определяла наш файл не просто как "text/plain", а как "application/x-bulka"? Чтобы быть уверенным, что любая программа определит наш тип точно.</p>
<p>Это сделать можно. Но поскольку <strong><i>file</i></strong> читает содержимое файла, чтобы определить его тип, нам нужно добавить внутрь файла какой-то опознавательный знак - что-то, что будет отличать наш тип файла, от обычного текстового. Что-то типа сигнатуры. Допустим, пусть у нас файл начинается со строки "BULKA!".</p>
<pre><code class="language-bash">
   # содержимое моего файла myfile.bulka:
   BULKA!
   Первая строка, которую мы вставляем в файл.
   Вторая строка.
</code></pre>

<p>Теперь нам надо указать утилите file, что все текстовые файлы, которые начинаются со строки "BULKA!", относятся к типу "application/x-bulka".</p>
<pre><code class="language-bash"># файл ~/.magic:
   0   string BULKA!   application/x-bulka
   !:mime   application/x-bulka
</code></pre>

<p>А вот пример файла ~/.magic с несколькими типами:</p>
<pre><code class="language-bash"># файл ~/.magic:

   0   string   FOO!   application/x-foobar
   !:mime   application/x-foobar

   0   string KAKA!   application/x-kaka
   !:mime   application/x-kaka

   0   string KAKA2! application/x-kaka2
   !:mime application/x-kaka2

   0   string BULKA!   application/x-bulka
   !:mime application/x-bulka
</code></pre>

<p>Теперь мы можем проверить тип нашего файла с помощью <strong><i>file</i></strong>:</p>
<pre><code class="language-bash">   file --mime-type myfile.bulka
      #  myfile.bulka: application/x-bulka
</code></pre>

<p>file определяет только по содержимому. А философия Freedesktop MIME: определять только по расширению, а не по магии!!!</p>

<h2>shared-mime-info</h2>

<p><strong><i>shared-mime-info</i></strong> - это стандарт Freedesktop и набор файлов, которые описывают все известные MIME-типы для Linux (и других Unix-подобных систем).</p>
<pre><code class="language-bash">   # Системные MIME-типы:
   /usr/share/mime/

   # Пользовательские MIME-типы:
   ~/.local/share/mime/
</code></pre>

<ul>
    <li><strong><i>~/.local/share/mime/globs</i></strong> — основное сопоставление расширение → MIME-тип.</li>
    <li><strong><i>~/.local/share/mime/globs2</i></strong> — то же самое, но с приоритетами (номер перед типом = вес, чем больше, тем выше приоритет).</li>
    <li><strong><i>~/.local/share/mime/types</i></strong> — список всех известных MIME-типов (реестр).</li>
    <li><strong><i>~/.local/share/mime/application/x-bulka.xml</i></strong> — скомпилированная копия моего XML-описания (из packages/).</li>
    <li><strong><i>~/.local/share/mime/mime.cache</i></strong> — бинарная база, в которую всё это компилируется (её как раз обновляет update-mime-database).</li>
    <li><strong><i>~/.local/share/mime/packages/application-x-bulochka.xml</i></strong> — это оригинальный XML-файл, который я создал и по которому всё построилось.</li>
</ul>

<p>Программы, которые используют <strong><i>shared-mime-info</i></strong>, тоже могут определять тип файла по его содержимому. Для этого в XML-файлах предусмотрена директива <strong><i>&lt;magic&gt;</i></strong>. Давайте подправим наш файл <strong><i>application-x-bulochka.xml</i></strong> таким образом, чтобы <strong><i>shared-info-mime</i></strong>-программы прочитывали из первой строки файла нашу сигнатуру "BULKA!".</p>
<pre><code class="language-xml">&lt;!-- ~/.local/share/mime/packages/application-x-bulochka.xml --&gt;

   &lt;mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info"&gt;
       &lt;mime-type type="application/x-bulka"&gt;
           &lt;magic priority="80"&gt;
               &lt;match type="string" value="BULKA!" offset="0"/&gt;
           &lt;/magic&gt;
           &lt;!-- Распознавание файла по расширению я удалил --&gt;
       &lt;/mime-type&gt;
   &lt;/mime-info&gt;
</code></pre>

<p>После того, как мы изменили содержимое XML-файла, запустим команду:</p>
<pre><code class="language-bash">   update-mime-database ~/.local/share/mime
</code></pre>

<p>Теперь давайте попробуем определить тип файла <strong><i>myfile.bulka</i></strong> с помощью <strong><i>gio</i></strong>:</p>
<pre><code class="language-bash">
# Если у нас в файле первая строка: "BULKA!":
   gio info myfile.bulka | grep content-type
      #  standard::content-type: application/x-bulka
      #  standard::fast-content-type: application/octet-stream

# Если мы убираем "BULKA!" из первой строки:
   gio info myfile.bulka | grep content-type
      #  standard::content-type: text/plain
      #  standard::fast-content-type: application/octet-stream
</code></pre>

<p>То есть теперь <strong><i>gio</i></strong> определяет тип файла на основе его содержимого.</p>
<p>А теперь давайте усложним XML-правило. <strong><i>&lt;match&gt;</i></strong> может быть и вложенным.</p>

<pre><code class="language-xml">&lt;!-- ~/.local/share/mime/packages/application-x-bulochka.xml --&gt;

&lt;mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info"&gt;
    &lt;mime-type type="application/x-bulka"&gt;
        &lt;magic priority="80"&gt;
            &lt;match type="string" value="BULKA!" offset="0"&gt;
                &lt;match type="string" value="V2" offset="6"/&gt;
            &lt;/match&gt;
        &lt;/magic&gt;
        &lt;!-- Распознавание файла по расширению я удалил --&gt;
    &lt;/mime-type&gt;
&lt;/mime-info&gt;
</code></pre>
<p>Теперь <strong><i>gio</i></strong> будет определять тип файла как "application/x-bulka" только если первая строка равна: "BULKA!V2".</p>

<p>Ещё пример XML-файла. То же самое, что и в предыдущем примере, но только здесь мы добавили распознавание файла по расширению. Сначал идёт проверка по содержимому. Если "BULKA!" и "V2" не совпали, то тогда мы смотрим на расширение файла. Если оно равно: ".bulka", то тогда тип нашего файла всё равно: "application/x-bulka".</p>
<pre><code class="language-xml">&lt;!-- ~/.local/share/mime/packages/application-x-bulochka.xml --&gt;

&lt;mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info"&gt;
    &lt;mime-type type="application/x-bulka"&gt;
        &lt;magic priority="80"&gt;
            &lt;match type="string" value="BULKA!" offset="0"&gt;
                &lt;match type="string" value="V2" offset="6"/&gt;
            &lt;/match&gt;
        &lt;/magic&gt;
        &lt;!-- Здесь &lt;glob&gt; находится ПОСЛЕ &lt;magic&gt; --&gt;
        &lt;glob pattern="*.bulka"/&gt;
    &lt;/mime-type&gt;
&lt;/mime-info&gt;
</code></pre>


<p>В следующем XML-фрагменте мы переместили &lt;glob&gt; НАД &lt;magic&gt;, чтобы продемонстрировать, что порядок написания правил не влияет на приоритет. Приоритет всегда у MAGIC. Сначала проверяется содержимое файла, а потом расширение.</p>
<pre><code class="language-xml">&lt;!-- ~/.local/share/mime/packages/application-x-bulochka.xml --&gt;

&lt;mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info"&gt;
    &lt;mime-type type="application/x-bulka"&gt;
        &lt;!-- Тут мы переместили &lt;glob&gt; выше - НАД &lt;magic&gt; --&gt;
        &lt;glob pattern="*.bulka"/&gt;
        &lt;magic priority="80"&gt;
            &lt;match type="string" value="BULKA!" offset="0"&gt;
                &lt;match type="string" value="V2" offset="6"/&gt;
            &lt;/match&gt;
        &lt;/magic&gt;
    &lt;/mime-type&gt;
&lt;/mime-info&gt;
</code></pre>

<p>Аттрибут "priority" указывает приоритет данного правила. Например, у PNG-файлов (MIME-тип: <strong><i>image/png</i></strong>) в системе по умолчанию приоритет "50". Если я хочу создать своё правило для <strong><i>image/png</i></strong>, то мне нужно указать приоритет выше "50" и тогда моё правило переопределит системное.</p>
<p>Давайте посмотрим на пример XML-файла для <strong><i>image/png</i></strong>, который приведён на сайте <a href="https://www.freedesktop.org/wiki/Specifications/AddingMIMETutor/">freedesktop.org</a>:</p>
<pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info"&gt;
   &lt;mime-type type="image/png"&gt;
      &lt;comment xml:lang="en"&gt;PNG image&lt;/comment&gt;
      &lt;comment xml:lang="af"&gt;png beeld&lt;/comment&gt;
      ...
      &lt;magic priority="50"&gt;
         &lt;match type="string" value="\x89PNG" offset="0"/&gt;
      &lt;/magic&gt;
      &lt;glob pattern="*.png"/&gt;
   &lt;/mime-type&gt;
&lt;/mime-info&gt;
</code></pre>
<p>Здесь "\x89PNG" - это сигнатура первых байтов для формата PNG.</p>

<p></p>
<pre><code class="language-bash">

</code></pre>


<ul>
<li><a href="https://www.freedesktop.org/wiki/Specifications/AddingMIMETutor/">AddingMIMETutor</a></li>
<li><a href="https://www.freedesktop.org/wiki/Specifications/config-spec/">https://www.freedesktop.org/wiki/Specifications/config-spec/</a></li>
<li><a href="https://specifications.freedesktop.org/desktop-entry-spec/0.9.5/mime-types.html">Registering MIME Types</a></li>
<li><a href="https://specifications.freedesktop.org/shared-mime-info-spec/latest/ar01s02.html">Unified system</a></li>
</ul>


<script src="/assets/highlight/languages/bash.min.js"></script>
<script src="/assets/highlight/languages/xml.min.js"></script>
<script>hljs.highlightAll();</script>
</body>
</html>