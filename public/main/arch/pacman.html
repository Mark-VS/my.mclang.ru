<!DOCTYPE html>
<html lang="RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pacman</title>
    <link rel="stylesheet" href="/assets/styles/style.css">
	<link rel="stylesheet" href="/assets/highlight/styles_custom/androidstudio.css">
</head>
<body>
<script src="/assets/highlight/highlight.min.js"></script>
<a href="/arch">Вернуться назад</a>

    <h1>Pacman</h1>

	<pre><code class="language-bash">
# update system
# sudo pacman -Syu
   -S - Synchronize: Install or update packages
   -y - Refresh package database (download the latest package lists)
   -u - Upgrade all installed packages to the latest version
# Refresh package list (not upgrade):
   sudo pacman -Sy

# Remove
sudo pacman -Rns budgie-desktop gnome xfce4 xfce4-goodies
   -R - remove a packager
   -n - remove configuration files and mark dependencies as unused
   -s - remove unused dependencies that were installed with the package

sudo pacman -Rdd linux-firmware
   -R - удалить пакет
   -d - игнорировать зависимости (один -d)
   -dd - игнорировать зависимости дважды (то есть вообще никакие зависимости):
      - не проверят, что от пакета кто-то зависит (обратные зависимости);
      - не проверять, что сам пакет зависит от чего-то.
  
# Найти пакет в репозитории:
pacman -Ss strawberry

# Вывести подробную информацию об этом пакете:
pacman -Si strawberry

# Найти пакет среди установленных в системе:
pacman -Q sway

# Найти пакет среди установленных в системе:
pacman -Qs sway

# Вывести подробную информацию о нём:
pacman -Qi sway

# Найти в репозитории пакеты, принадлежащие группе plasma:
pacman -Sg plasma

# Найти среди установленных пакетов пакеты из группы plasma:
pacman -Qg plasma

# Список всех пакетов в репозитории multilib:
pacman -Sl multilib
# Список всех пакетов во всех доступных репозиториях:
pacman -Sl
	</code></pre>

  <h3>Логи</h3>

  <p>Логи пишутся в <strong><i>/var/log/pacman.log</i></strong>. Если во время установки пакета произошла какая-то ошибка и мы хотим посмотреть подробности, просто смотрим в этот лог и ищем "ERROR":</p>
  <pre><code class="language-bash">tail -n 50 /var/log/pacman.log</code></pre>

  <h3>КЭШ</h3>

	<ul>
		<li>/var/cache/pacman/pkg/ - Каталог для кэша → это именно пакеты (*.pkg.tar.zst), которые pacman скачивает.</li>
		<li>/var/lib/pacman/ - Каталог баз данных → там лежат репозитории (файлы с информацией о пакетах).
Если ты удалишь "неиспользуемые репозитории", это просто почистит каталоги баз тех репозиториев, которые у тебя больше не подключены в /etc/pacman.conf.</li>
		<li>/var/lib/pacman/local/ - Здесь хранятся данные обо всех установленных пакетах (каждый пакет — отдельная папка).
Внутри есть файлы вроде desc, files, где перечислены версия, зависимости, список установленных файлов и т. д. Это и есть «реестр» pacman'а.</li>
		<li>/var/lib/pacman/sync - Здесь хранятся локальные копии баз данных репозиториев (например core.db, extra.db, community.db). Когда я выполняю: pacman -Sy или -Syu, они обновляются.</li>
		<li>/var/lib/pacman/sync - Здесь также хранятся локальные копии баз данных файлов (например core.files, extra.files, multilib.files). Когда я выполняю: pacman -Fy, они обновляются.</li>
	</ul>
	
	<pre><code class="language-bash">
# Очистить кэш pacman:
  sudo pacman -Sc
  # Удаляет старые версии пакетов из /var/cache/pacman/pkg/
  # но оставляет последнюю скачанную версию каждого пакета
  # (чтобы можно было переустановить без интернета).
  
  # Также удаляет неиспользуемые репозитории из /var/lib/pacman/sync/
  # То есть если я удалю из /etc/pacman.conf:
  #   [multilib]
  #   Include = /etc/pacman.d/mirrorlist
  # а потом запущу команду "sudo pacman -Sc" -
  # тогда pacman удалит копию репозитория /var/lib/pacman/sync/multilib.db
  
  sudo pacman -Scc
  # удаляет вообще всё из /var/cache/pacman/pkg/ (и старые, и последние версии).
  # pacman даже предупреждает:
  # "Удаление всех пакетов может привести к невозможности переустановки без скачивания заново".
  
  # Чистит только /var/cache/pacman/pkg/ и /var/lib/pacman/
  # 
  # Папку ~/.cache/ не очищает
	</code></pre>
	
   	<h4>То есть:</h4>
	<ul>
		<li>Если хочешь немного освободить место, но оставить возможность быстро переустановить → pacman -Sc.</li>
		<li>Если хочешь чистый кэш, всё скачать заново при необходимости → pacman -Scc.</li>
	</ul>
	
   	<h4>Для AUR ситуация схожа:</h4>
	<ul>
		<li>yay -Sc — чистит старые, оставляет актуальные сборки.</li>
		<li>yay -Scc — чистит вообще всё, но git-репозитории пакетов остаются (в ~/.cache/yay).</li>
	</ul>

	<pre><code class="language-bash">
   # ~/.cache/yay/ - кэш yay
   
   # yay -Sc	 - делает не только очистку своего кэша, но ещё и проксирует вызов в pacman -Sc.
   yay -Sc	# очистка обоих кэшей - и yay, и pacman
   yay -Sc --yay	# почистить только кэш yay, без затрагивания pacman
   yay -Sc --pacman	# почистить pacman, не затрагивая yay
   
   yay -Scc	# очистка обоих кэшей - и yay, и pacman
   yay -Scc --yay	# почистить только кэш yay, без pacman
   yay -Scc --pacman	# почистить только кэш pacman, без yay
	</code></pre>
	
	<pre><code class="language-bash">
   # ~/.cache/paru/ - кэш paru
   
   paru -Sc	# очитска обоих кэшей - и paru, и pacman
   paru -Sc --paru	# очистить только кэш paru
   paru -Sc --pacman	# очистить только кэш pacman
   
   paru -Scc	# очистить оба кэша - и paru, и pacman
   paru -Scc --paru	# очистть только кэш paru
   paru -Scc --pacman	# очистить только кэш pacman
	</code></pre>


	<h4>Скачать пакет, но не устанавливать его</h4>
	<pre><code class="language-bash">
# Скачать пакет в домашнюю папку:
sudo pacman -Sw vim --cachedir="/home/mark"

# А так пакет скачается в /var/cache/pacman/pkg/
sudo pacman -Sw vim

# Скачаются два файла:
#    filename.pkg.tar.zst,
#    filename.pkg.tar.zst.sig
	</code></pre>

	<h4>Установить собранный ранее пакет (.pkg.tar.zst):</h4>
	<pre><code class="language-bash">
# Устанавливаем пакет из текущей директории:
sudo pacman -U paru-2.1.0-1-x86_64.pkg.tar.zst

# Если я ранее скачал пакет в /var/cache/pacman/pkg, то ...
# при последующей установке можно не писать путь к нему целиком.
sudo pacman -U filename.pkg.tar.zst
# и pacman найдёт его в /var/cache/pacman/pkg и установит
# (если в текущей папке нет пакета с таким же названием).
</code></pre>
	
	<h4>Узнать, какому пакету принадлежит бинарник:</h4>
	<pre><code class="language-bash">pacman -Qo /usr/bin/package-name

# Узнать, какому пакету принадлежит v4l2-ctl:
pacman -Qo v4l2-ctl
   # /usr/bin/v4l2-ctl принадлежит v4l-utils 1.32.0-1

# Узнать, какому пакету принадлежит gio:
pacman -Qo gio
   # /usr/bin/gio принадлежит glib2 2.86.1-1
  </code></pre>

  <h3>Узнать, какие файлы в системе использует пакет</h3>
  <p>Или, если попытаться перефразировать, я, например, хочу знать, какие файлы и куда раскидывает их по системе пакет, который я ставлю.</p>

  <pre><code class="language-bash"># На примере archlinux-keyring:

pacman -Ql archlinux-keyring
  </code></pre>
	
	<h4>Узнать, какому пакету принадлежит утилита:</h4>
	<pre><code class="language-bash">
# Например, я хочу установить утилиту netstat.
# Но я не знаю, какой ставить пакет, чтобы я смог ей воспользоваться.
pacman -F netstat

# Теперь я знаю, что утилита netstat ...
# находится в пакете net-tools и просто ставлю этот пакет:
sudo pacman -S net-tools

# Чтобы осуществлять поиск (pacman -F), нужно предварительно ...
# скачать базу данных файлов себе в локальное хранилище (/var/lib/pacman/sync):
sudo pacman -Fy
	</code></pre>

  <p>Базы данных core.db, extra.db, multilib.db содержат список пакетов, их версии, зависимости и описания. Но они не содержат полный список файлов внутри пакетов. Поэтому есть дополнительные базы: core.files, extra.files, multilib.files. Все эти базы данных находятся в <strong><i>/var/lib/pacman/sync/</i></strong>.</p>

  <h3>ключи</h3>
  
  <p>Ключи хранятся в папке <strong><i>/etc/pacman.d/gnupg</i></strong>.</p>

  <pre><code class="language-bash"># Обновить пакет archlinux-keyring
# Это самое важное — без этого новые ключи не появятся:
sudo pacman -Sy archlinux-keyring

# Если ключи сломались сильно — ставят принудительно:
sudo pacman -S --needed archlinux-keyring

# Обновить сам keyring в pacman-key:
sudo pacman-key --refresh-keys
   # Это перезапросит ключи с ключевых серверов.

# Если --refresh-keys выдаёт ошибки из-за сервера, можно попробовать:
sudo pacman-key --refresh-keys --keyserver hkps://keyserver.ubuntu.com

# Полная перезагрузка ключей (если всё сломано)
sudo pacman-key --init
sudo pacman-key --populate archlinux
   # только если pacman больше не принимает подписи.
  </code></pre>

  <p>Внутри пакета <strong><i>archlinux-keyring</i></strong> содержатся публичные ключи всех официальных мейнтейнеров Arch, сертификаты доверия, информация о том, какие ключи отозваны или устарели. То есть это просто набор файлов с ключами.</p>

  <p style="margin-bottom: 2px">что делает <strong><i>pacman-key --init</i></strong>:</p>
  <ul style="margin-top: 0; margin-bottom: 0">
    <li>создаёт (генерирует) локальную GnuPG-базу pacman</li>
    <li>генерирует локальные мастер-ключи (система доверия)</li>
  </ul>
  <p style="margin-top: 2px">Т.е., грубо говоря — готовит пустую базу для ключей.</p>
  <p style="margin-bottom: 2px">А что делает <strong><i>pacman-key --populate archlinux</i></strong>:</p>
  <ul style="margin-top: 0">
    <li>берёт ключи из пакета <strong><i>archlinux-keyring</i></strong> и импортирует их в <strong><i>/etc/pacman.d/gnupg/</i></strong></li>
    <li>устанавливает уровни доверия (trust)</li>
  </ul>
  <h4>pactree</h4>
  <pre><code class="language-bash"># Посмотреть зависимости sway
pactree sway
   # т.е. мы увидим, что нужно sway, чтобы работать

# Посмотреть обратные зависимости:
pactree -r sway
   # т.е. програмы, которые зависят от sway
  </code></pre>


<h2>Подключаем Chaotic AUR</h2>

<p style="margin-bottom: 6px">Всю инструкцию по подключению можно найти на официальной страничке.</p>
<pre style="margin-top: 6px"><code class="language-bash">sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
sudo pacman-key --lsign-key 3056513887B78AEB
sudo pacman -U https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst
sudo pacman -U https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst
</code></pre>
<h4 style="margin-bottom: 6px">пояснения</h4>
<ul style="margin-top: 6px">
   <li>pacman-key – обёртка над gpg</li>
   <li>--recv-key – скачать публичный ключ</li>
   <li>3056513887B78AEB – ID GPG-ключа Chaotic-AUR</li>
   <li>keyserver.ubuntu.com – сервер ключей</li>
</ul>
<p>На этом этапе публичный ключ загружен. Но ему ещё не доверяют. Это выглядит так: «Я знаю этот паспорт, но не уверен, что он настоящий». Поэтому далее надо выполнить локальное подписание ключа.</p>
<ul>
   <li>--lsign-key = locally sign</li>
</ul>
<p>Тут я подписываю ключ своим ключом <strong><i>pacman</i></strong>. Это не отправляется в интернет – только у меня. То есть я как бы говорю: «Я лично доверяю этому ключу на этом компьютере». Без этого шага <strong><i>pacman</i></strong> откажется устанавливать пакеты.</p>
<ul>
   <li>Установка <strong>keyring</strong>-пакета. <strong><i>chaotic-keyring</i></strong> – пакет с набором всех GPG-ключей, которыми подписываются пакеты <strong>Chaotic-AUR</strong>. Аналог <strong><i>archlinux-keyring</i></strong>. Без предыдущего шага установить этот пакет не получится, потому что он тоже подписан ключом, который я добавил чуть выше. Сначала я доверяю главному ключу, потом он разрешает доверять всем остальным.</li>
   <li>Установка mirrorlist. Это список зеркал репозитория. Зачем устанавливать это отдельно? Потому что <strong><i>pacman</i></strong> не знает откуда скачивать пакеты <strong>Chaotic-AUR</strong>. <strong><i>mirrorlist</i></strong> – это просто конфиг, не код.</li>
</ul>
<p>Добавляем в <strong><i>/etc/pacman.conf</i></strong> в самый низ:</p>
<pre><code class="language-bash">[chaotic-aur]
Include = /etc/pacman.d/chaotic-mirrorlist
</code></pre>

<p>Обновляем базы:</p>
<pre><code class="language-bash">sudo pacman -Sy
</code></pre>


	<h4>Расшифровка</h4>
	<pre><code class="language-bash">
sudo pacman -Syu
sudo pacman --sync --refresh --sysupgrade

sudo pacman -Rns
sudo pacman --remove --nosave --recursive

sudo pacman -Sw vim --cachedir="/home/mark"
sudo pacman --sync --downloadonly vim --cachedir="/home/mark"

sudo pacman -U package.pkg.tar.zst
sudo pacman --upgrade package.pkg.tar.zst

sudo pacman -Fy
sudo pacman --files --refresh

pacman -Qo v4l2-ctl
pacman --query --owns v4l2-ctl

pacman -Sl multilib
pacman --sync --list multilib

pacman -Scc
pacman --sync --clean --clean

pacman -Dk
pacman --database --check

pacman -Dkk
pacman --database --check --check
	</code></pre>

<script src="/assets/highlight/languages/bash.min.js"></script>
<script>hljs.highlightAll();</script>
</body>
</html>